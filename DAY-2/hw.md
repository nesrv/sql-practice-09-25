# Домашнее задание по модулям 3-4
## Анализ данных на языке SQL

**Время выполнения:** 4 часа  
**Темы:** CRUD операции, JOIN, операции с множествами, представления, агрегатные функции, HAVING

---

## Подготовка данных

Создайте базу данных и выполните следующие команды:

```sql
-- Таблица категорий товаров
CREATE TABLE categories (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    description TEXT
);

-- Таблица поставщиков
CREATE TABLE suppliers (
    supplier_id SERIAL PRIMARY KEY,
    supplier_name VARCHAR(100) NOT NULL,
    contact_person VARCHAR(100),
    phone VARCHAR(20),
    city VARCHAR(50)
);

-- Таблица товаров
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(100) NOT NULL,
    category_id INTEGER REFERENCES categories(category_id),
    supplier_id INTEGER REFERENCES suppliers(supplier_id),
    price DECIMAL(10,2),
    stock_quantity INTEGER,
    created_date DATE DEFAULT CURRENT_DATE
);

-- Таблица клиентов
CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    customer_name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    city VARCHAR(50),
    registration_date DATE DEFAULT CURRENT_DATE
);

-- Таблица заказов
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers(customer_id),
    order_date DATE DEFAULT CURRENT_DATE,
    total_amount DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'pending'
);

-- Таблица позиций заказов
CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(order_id),
    product_id INTEGER REFERENCES products(product_id),
    quantity INTEGER,
    unit_price DECIMAL(10,2)
);

-- Заполнение тестовыми данными
INSERT INTO categories (category_name, description) VALUES
('Электроника', 'Компьютеры, телефоны, планшеты'),
('Книги', 'Художественная и техническая литература'),
('Одежда', 'Мужская и женская одежда'),
('Спорт', 'Спортивные товары и инвентарь');

INSERT INTO suppliers (supplier_name, contact_person, phone, city) VALUES
('ТехноСнаб', 'Иванов И.И.', '+7-495-123-4567', 'Москва'),
('КнигоМир', 'Петрова А.С.', '+7-812-234-5678', 'СПб'),
('МодаСтиль', 'Сидоров П.П.', '+7-495-345-6789', 'Москва'),
('СпортЛайн', 'Козлова М.В.', '+7-343-456-7890', 'Екатеринбург');

INSERT INTO products (product_name, category_id, supplier_id, price, stock_quantity) VALUES
('Ноутбук ASUS', 1, 1, 75000.00, 15),
('iPhone 15', 1, 1, 89000.00, 25),
('Война и мир', 2, 2, 1200.00, 50),
('Джинсы Levis', 3, 3, 8500.00, 30),
('Кроссовки Nike', 4, 4, 12000.00, 40),
('Планшет iPad', 1, 1, 65000.00, 18),
('Python для начинающих', 2, 2, 2500.00, 35),
('Куртка зимняя', 3, 3, 15000.00, 20),
('Мяч футбольный', 4, 4, 3500.00, 60),
('Наушники Sony', 1, 1, 8000.00, 45);

INSERT INTO customers (customer_name, email, city) VALUES
('Алексей Петров', 'alex@email.com', 'Москва'),
('Мария Сидорова', 'maria@email.com', 'СПб'),
('Дмитрий Козлов', 'dmitry@email.com', 'Екатеринбург'),
('Елена Иванова', 'elena@email.com', 'Москва'),
('Андрей Смирнов', 'andrey@email.com', 'Новосибирск');

INSERT INTO orders (customer_id, order_date, total_amount, status) VALUES
(1, '2024-01-15', 83000.00, 'completed'),
(2, '2024-01-20', 3700.00, 'completed'),
(3, '2024-02-01', 23500.00, 'pending'),
(1, '2024-02-05', 65000.00, 'completed'),
(4, '2024-02-10', 27000.00, 'shipped'),
(5, '2024-02-15', 12000.00, 'pending');

INSERT INTO order_items (order_id, product_id, quantity, unit_price) VALUES
(1, 2, 1, 89000.00), (1, 3, 2, 1200.00),
(2, 3, 1, 1200.00), (2, 7, 1, 2500.00),
(3, 4, 1, 8500.00), (3, 8, 1, 15000.00),
(4, 6, 1, 65000.00),
(5, 5, 1, 12000.00), (5, 8, 1, 15000.00),
(6, 5, 1, 12000.00);
```

---

## Задание 1: CRUD операции (30 минут)

### 1.1 CREATE - Добавление данных
```sql
-- Добавьте новую категорию "Дом и сад"
-- Добавьте нового поставщика из вашего города
-- Добавьте 3 новых товара в созданную категорию
```

### 1.2 READ - Выборка данных
```sql
-- Выведите все товары дороже 10000 рублей
-- Найдите всех клиентов из Москвы
-- Покажите заказы за февраль 2024 года
```

### 1.3 UPDATE - Обновление данных
```sql
-- Увеличьте цены всех товаров категории "Электроника" на 5%
-- Измените статус заказа с ID=3 на "completed"
-- Обновите количество товара "Мяч футбольный" до 100 штук
```

### 1.4 DELETE - Удаление данных
```sql
-- Удалите товары с нулевым остатком (если есть)
-- Удалите клиентов без заказов (осторожно с внешними ключами!)
```

---

## Задание 2: JOIN операции (45 минут)

### 2.1 INNER JOIN
```sql
-- Выведите список товаров с названиями категорий и поставщиков
-- Покажите заказы клиентов с их именами и городами
-- Найдите все позиции заказов с названиями товаров
```

### 2.2 LEFT JOIN
```sql
-- Выведите всех клиентов и количество их заказов (включая клиентов без заказов)
-- Покажите все категории и количество товаров в каждой
-- Найдите поставщиков и общую стоимость их товаров на складе
```

### 2.3 Сложные JOIN
```sql
-- Создайте отчет: клиент, заказ, товар, категория, поставщик
-- Найдите топ-3 самых популярных товара по количеству заказов
-- Выведите клиентов, которые покупали товары из категории "Электроника"
```

---

## Задание 3: Операции с множествами (30 минут)

### 3.1 UNION
```sql
-- Объедините списки клиентов из Москвы и поставщиков из Москвы
-- Создайте общий список всех городов (клиентов и поставщиков)
```

### 3.2 EXCEPT
```sql
-- Найдите товары, которые есть на складе, но не были заказаны
-- Выведите категории, в которых нет товаров
```

### 3.3 INTERSECT
```sql
-- Найдите города, где есть и клиенты, и поставщики
-- Определите товары, которые заказывали клиенты из Москвы
```

---

## Задание 4: Агрегатные функции и GROUP BY (45 минут)

### 4.1 Базовые агрегации
```sql
-- Подсчитайте общее количество товаров на складе
-- Найдите среднюю цену товара в каждой категории
-- Определите максимальную и минимальную сумму заказа
```

### 4.2 GROUP BY с JOIN
```sql
-- Выведите количество заказов по каждому клиенту
-- Покажите общую выручку по каждому поставщику
-- Найдите среднюю стоимость заказа по городам клиентов
```

### 4.3 Сложные группировки
```sql
-- Создайте отчет по продажам: категория, количество заказанных товаров, общая сумма
-- Найдите топ-5 клиентов по общей сумме заказов
-- Выведите статистику заказов по месяцам (количество и сумма)
```

---

## Задание 5: HAVING и фильтрация групп (30 минут)

### 5.1 Базовый HAVING
```sql
-- Найдите категории с более чем 2 товарами
-- Выведите клиентов с общей суммой заказов больше 50000
-- Покажите поставщиков, у которых средняя цена товара выше 10000
```

### 5.2 Сложные условия HAVING
```sql
-- Найдите города с более чем одним клиентом И общей суммой заказов > 100000
-- Выведите категории, где разница между max и min ценой больше 50000
-- Покажите месяцы, где количество заказов больше среднего по всем месяцам
```

---

## Задание 6: Представления (VIEW) (30 минут)

### 6.1 Создание представлений
```sql
-- Создайте представление "popular_products" с товарами, которые заказывали более 1 раза
-- Создайте представление "customer_stats" с статистикой по клиентам
-- Создайте представление "monthly_sales" с продажами по месяцам
```

### 6.2 Использование представлений
```sql
-- Используйте созданные представления для анализа данных
-- Создайте запрос, объединяющий несколько представлений
```

---

## Задание 7: Подготовленные операторы (20 минут)

```sql
-- Создайте подготовленный оператор для поиска товаров по категории
-- Создайте подготовленный оператор для добавления нового заказа
-- Создайте подготовленный оператор для обновления статуса заказа
```

---

## Задание 8: Аналитические запросы (40 минут)

### 8.1 Бизнес-аналитика
```sql
-- Найдите самый прибыльный месяц
-- Определите категорию с наибольшей средней стоимостью товара
-- Выведите клиентов, которые не делали заказы в последние 30 дней
```

### 8.2 Сложная аналитика
```sql
-- Создайте ABC-анализ товаров (по выручке)
-- Найдите товары, которые часто покупают вместе
-- Определите сезонность продаж по категориям
```

### 8.3 Отчеты
```sql
-- Создайте сводный отчет по продажам: поставщик, категория, количество, сумма
-- Постройте рейтинг клиентов по активности (количество заказов + сумма)
-- Создайте отчет по эффективности поставщиков
```

---

## Дополнительные задания (для продвинутых)

### Задание 9: Оптимизация
```sql
-- Создайте индексы для ускорения частых запросов
-- Проанализируйте планы выполнения сложных запросов
-- Предложите альтернативные варианты медленных запросов
```

### Задание 10: Курсоры
```sql
-- Создайте функцию с курсором для пакетной обработки заказов
-- Используйте курсор для постраничного вывода товаров
```

---



## Сдача работы

1. Создайте файл `homework_solution.sql` с вашими решениями
2. Добавьте комментарии к сложным запросам
3. Включите результаты выполнения ключевых запросов
4. Опишите возникшие трудности и способы их решения

